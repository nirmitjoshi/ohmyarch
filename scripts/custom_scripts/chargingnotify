#!/usr/bin/env sh
# Usage: chargingnotify 1 | chargingnotify 0

[ $# -ne 1 ] && printf 'usage: %s 0|1\n' "$0" && exit 1

BAT="BAT0"
P="/sys/class/power_supply/$BAT"

CAP=$(cat "$P/capacity")

ENERGY_NOW=$(cat "$P/energy_now" 2>/dev/null || cat "$P/charge_now")
ENERGY_FULL=$(cat "$P/energy_full" 2>/dev/null || cat "$P/charge_full")
POWER_NOW=$(cat "$P/power_now" 2>/dev/null || echo 0)

TARGET=80

format_time() {
  awk -v t="$1" 'BEGIN {
    h = int(t);
    m = int((t - h) * 60);
    if (h > 0) printf "%dh %dm", h, m;
    else printf "%dm", m;
  }'
}

LINE="time unavailable"

if [ "$POWER_NOW" -gt 0 ]; then
  if [ "$1" -eq 1 ]; then
    TARGET_ENERGY=$(awk "BEGIN { print $ENERGY_FULL * $TARGET / 100 }")
    if [ "$ENERGY_NOW" -lt "$TARGET_ENERGY" ]; then
      HOURS=$(awk "BEGIN { print ($TARGET_ENERGY - $ENERGY_NOW) / $POWER_NOW }")
      LINE="charged to ${TARGET}% in $(format_time "$HOURS")"
    else
      LINE="already above ${TARGET}%"
    fi
  elif [ "$1" -eq 0 ]; then
    HOURS=$(awk "BEGIN { print $ENERGY_NOW / $POWER_NOW }")
    LINE="$(format_time "$HOURS") left"
  fi
fi

if [ "$1" -eq 1 ]; then
  notify-send -u low \
    -h string:x-dunst-stack-tag:battery-state \
    "charging (${CAP}%)" \
    "$LINE"
elif [ "$1" -eq 0 ]; then
  notify-send -u low \
    -h string:x-dunst-stack-tag:battery-state \
    "discharging (${CAP}%)" \
    "$LINE"
fi
